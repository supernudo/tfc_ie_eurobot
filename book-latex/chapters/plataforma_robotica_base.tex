%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Generic template for TFC/TFM/TFG/Tesis
%
% $Id: introduccion.tex,v 1.6 2014/02/11 11:00:06 macias Exp $
%
% By:
%  + Javier Macías-Guarasa.
%    Departamento de Electrónica
%    Universidad de Alcalá
%  + Roberto Barra-Chicote.
%    Departamento de Ingeniería Electrónica
%    Universidad Politécnica de Madrid
%
% Based on original sources by Roberto Barra, Manuel Ocaña, Jesús Nuevo,
% Pedro Revenga, Fernando Herránz and Noelia Hernández. Thanks a lot to
% all of them, and to the many anonymous contributors found (thanks to
% google) that provided help in setting all this up.
%
% See also the additionalContributors.txt file to check the name of
% additional contributors to this work.
%
% If you think you can add pieces of relevant/useful examples,
% improvements, please contact us at (macias@depeca.uah.es)
%
% Copyleft 2013
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Plataforma robótica base}
\label{cha_plataforma_robotica_base}

\begin{FraseCelebre}
  \begin{Frase}
La imaginación es más importante que el conocimiento. El conocimiento es limitado y la imaginación circunda el mundo.    
  \end{Frase}
  \begin{Fuente}
Albert Einstein, en \emph{The Saturday Evening Post}
  \end{Fuente}
\end{FraseCelebre}


%\section{Introducción}

En el año 2010 se desarrolló una plataforma robótica base, cuyo diseño fue reutilizado y mejorado en el desarrollo de robots posteriores. Dicha plataforma incluye las funcionalidades básicas de un robot de Eurobot vistas en el capitulo \ref{cha_el_robot_de_eurobot}:

\begin{itemize}
\item Desplazamiento y localización
\item Evitación de obstáculos
\item Comunicación entre robots
\end{itemize}

El desarrollo de cada una de estas funcionalidades constituye en sí una la labor de ingeniería muy interesante que implica la aplicación de fundamentos de diferentes campos de la ciencia y la ingeniería. 

\section{Descripción general de la plataforma robótica}

La función de \textbf{desplazamiento y localización} de la plataforma robótica se implementa a partir de un \emph{sistema de tracción diferencial} y un \emph{sistema de posicionamiento por odometría}. Mediante la unión de estos dos sistemas implementa a su vez un \emph{control de posición polar}, a partir del cual, se gestiona la \emph{generación de trayectorias}.

Mecánicamente el sistema de tracción diferencial consiste en un bloque motor formado por dos motores unidos mediante una reductora mecánica a dos ruedas motrices (ver figura \ref{fig_plataforma_partes_1}). Sobre el eje motriz, en sus extremos, el robot tiene dos ruedas libres conectadas a sensores tipo encoder que se utilizan para implementar el sistema de posicionamiento por odometría y, junto con el bloque motor, el control de posición del robot.

\begin{figure}[ht]
\centering
\includegraphics[height=.3\textheight]{plataforma_partes_1}
\caption[Plataforma robótica base: partes del sistema de tracción diferencial y del sistema de control de posición]{Plataforma robótica base: partes del sistema de tracción diferencial y del sistema de control de posición. Robot Zamorano (Eurobot 2011).}
\label{fig_plataforma_partes_1}
\end{figure}

El \textbf{hardware desarrollado} de la plataforma robótica está compuesto por una tarjeta principal y varias tarjetas auxiliares que en conjunto tienen la capacidad de gestionar e implementar los sistemas mencionados anteriormente, así como los sistemas mecánicos específicos de la prueba de Eurobot, destinados a la manipulación de elementos de juego.

Respecto a la \textbf{evitación de obstáculos}, ésta se realiza a partir de sensores de distancia situados en las caras del robot (ver figura \ref{fig_plataforma_partes_2}) y a partir un sistema de balizas específicamente desarrollado para la medida de la posición del oponente. Este sistema hace uso de los soportes y espacios destinados a sistemas de balizas. Concretamente, el sistema desarrollado está basado en un sensor tipo faro situado en el robot y balizas reflectantes situadas en el oponente (ver figura \ref{fig_plataforma_partes_2}). El sistema de balizas es totalmente autónomo y se comunica mediante \emph{Bluetooth} con la tarjeta principal la plataforma robótica.

\begin{figure}[ht]
\centering
\includegraphics[height=.3\textheight]{plataforma_partes_2}
\caption[Plataforma robótica base: partes del sistema de evitación de obstáculos]{Plataforma robótica base: partes del sistema de evitación de obstáculos. Robot Zamorano (Eurobot 2011).}
\label{fig_plataforma_partes_2}
\end{figure}

La \textbf{implementación software} de todos los sistemas y funcionalidades de la plataforma robótica ha sido realizada a partir de las librerías Aversive4dspic. Estas librerías han sido migradas de las librerías Aversive \cite{aversive_src}, desarrolladas para microcontroladores AVR, a microcontroladores dsPIC (utilizados por la tarjeta principal de la plataforma robot). Entre las características de las librerías Aversive y Aversive4dspic se encuentran módulos específicos para la implementación de sistemas de control y de robots como los de Eurobot.

Por último, la plataforma robótica desarrollada permite que en caso de contar con \textbf{dos robots por equipo}, la misma  arquitectura mecánica, hardware y software pueda ser utilizada en el robot principal y secundario. Y la comunicación entre ambos robots puede ser implementada mediante la interfaz \emph{Bluetooth} de las tarjetas principales de cada robot.


\section{Sistema de tracción diferencial}
\label{sec_sistema_traccion_diferencial}
El sistema de tracción diferencial es uno de los más comunes en Eurobot, está compuesto por dos ruedas motrices unidas a motores mediante una reductora y varios puntos de apoyo (ver figura \ref{fig_plataforma_partes_1}). 

Dependiendo de la posición del eje motriz se dan 2 tipos de robots:

\begin{enumerate}
\item Robot con ruedas atrás: necesitan de dos puntos de apoyo delanteros.
\item Robot con ruedas en el medio: necesitan de puntos de apoyo delanteros y traseros.
\end{enumerate}

Los robots con ruedas atrás suelen tener dos puntos de apoyo delanteros. En cambio, los robots con ruedas en el medio suelen tener dos puntos de apoyo delanteros y otros dos traseros. Aunque a veces en uno de los extremos sólo llevan un punto de apoyo, 3 puntos de apoyo en total.

Como se verá más adelante, interesa un robot con ruedas en el medio y que tenga una simetría total de forma que todo el peso del robot recaiga sobre el eje motriz. Además, los puntos de apoyo han de estar a la mayor distancia posible del eje motriz. Esta situación no siempre se cumple, ya que existe un compromiso con el resto de elementos mecánicos del robot.

Los puntos de apoyo utilizados normalmente son de tipo \emph{rollon}. En caso de no disponer de espacio suficiente para ellos también es posible utilizar materiales de bajo coeficiente de rozamiento como el teflón (ver figura \ref{fig_sistema_traccion_rollones}).

\begin{figure}[ht]
\centering
\includegraphics[height=.3\textheight]{sistema_traccion_rollones}
\caption[]{Sistema de tracción diferencial del robot Automático (Eurobot 2013) visto desde abajo.}
\label{fig_sistema_traccion_rollones}
\end{figure}

Mecánicamente el conjunto de los motores, reductora y ruedas se denomina \emph{bloque motor}. El bloque motor se reutiliza como una parte independiente en cada diseño de un nuevo robot de forma que se sitúa sobre la base del robot adaptándose al resto de la mecánica.


\section{Sistema de posicionamiento y control de posición}
\label{sec_sma_posicionamiento_y_control}

La medida de la posición del robot se realiza mediante dos ruedas libres unidas a sensores tipo encoders. A partir de dicha medida de posición se implementa indirectamente el control de posición de los motores del sistema de tracción y de forma directa el sistema de posicionamiento por odometría del robot. Esta configuración difiere del esquema clásico en el que el encoder se encuentra conectado directamente al eje del motor, permite reducir los errores sistemáticos de odometría \cite{bor96_cap5} y que un posible deslizamiento o derrape de las ruedas motrices no afecte al control de posición del robot.

Es posible que además los motores tengan un encoder conectado directamente su eje de forma que se implemente un doble lazo de control: un control de posición o velocidad de los motores y un control de posición del robot. Sin embargo, el uso de encoders incrementales de al menos 2000 pulsos por vuelta en las ruedas libres y el hecho de que el robot siempre está en contacto con el suelo, hace que los encoders de los motores resultarían redundantes e incrementen el procesado software y los recursos necesarios del hardware.


\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{ruedas_libres_lineal}
\caption[]{Sistema de ruedas libres lineal}
\label{fig_ruedas_libres_lineal}
\end{figure}

Inicialmente, para el robot Trompetero (Eurobot 2010) se implemento un sistema de ruedas libres lineal como el de la figura \ref{fig_ruedas_libres_lineal}. Este sistema esta compuesto por una rueda que como neumático tiene una junta tórica de goma. Dicha rueda se encuentra conectada con un encoder incremental de dos canales en cuadratura. El conjunto rueda y encoder se encuentran fijados a la base del robot mediante un sistema de dos guías lineales con amortiguación. La amortiguación permite asegurar que ante cualquier desperfecto del campo la rueda siempre esté en contacto con el suelo. Cada guía tiene dos rodamientos lineales para disminuir el rozamiento. La implementación de este sistema mecánico es complejo y necesita de un ajuste de cierta precisión de forma que las dos guías lineales se encuentre perfectamente paralelas para que no existan rozamientos que impliquen errores no sistemáticos.

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{ruedas_libres_pivotante}
\caption[]{Sistema de ruedas libres pivotante}
\label{fig_ruedas_libres_pivotante}
\end{figure}

Un sistema mecánico más sencillo tanto en implementación y como en ajuste es el sistema de ruedas libres pivotante (ver figura \ref{fig_ruedas_libres_pivotante}). Este sistema fue implementado por primera vez en el robot secundario Seskapa (Eurobot 2014) dado el poco espacio disponible y posteriormente en los robots P.Tinto y Tirantes (Eurobot 2015). En este sistema, el conjunto rueda y encoder pivotan sobre un eje paralelo al eje motriz. Dicho eje se encuentra fijado a la base del robot mediante dos piezas con rodamientos de bolas separadas por un casquillo que evita que el eje se desplace. Este sistema tiene menos puntos de ajuste que el sistema lineal. Además la amortiguación del sistema es casi innecesaria debido al bajo rozamiento del eje con los rodamientos de bolas. El propio peso del conjunto rueda y encoder garantiza el contacto con el suelo. No obstante como se ve en la figura \ref{fig_ruedas_libres_pivotante} se utilizó unas gomas elásticas para asegurar el contacto con el suelo. El inconveniente de este sistema se debe al propio pivote, si el suelo tiene muchas imperfecciones, al pivotar la rueda esta se desalinea respecto al eje motriz, lo cual puede generar errores de medida de posición. Este echo es despreciable frente a la simplicidad de implementación mecánica y a que el suelo del campo de juego es plano.


\section{Estudio de la dinámica de robots de tracción diferencial}

El estudio de la dinámica de un robot de tracción diferencia permite conocer los límites de aceleración y velocidad a partir de los cuales dimensionar la reductora y los motores que mueven el robot.

En las siguientes secciones se analizar la dinámica de un robot de tracción diferencia en desplazamientos lineales sobre el plano horizontales. El modelo dinámico para este caso es sencillo y permite deducir restricciones mecánica muy útiles a la hora de diseñar un robot de estas características.

No es objeto de este proyecto analizar el modelo dinámico del robot para desplazamientos angulares. El cálculo de dicho modelo resulta muy complejo comparado con la influencia de estos movimientos en un robot de Eurobot. Es en los desplazamientos lineales donde el robot ha de adaptar su velocidad y aceleración para evitar chocar con el oponente o alcanzar una posición del campo.

\subsection{Dinámica básica en desplazamientos lineales sobre un plano horizontal}

Es importante entender la dinámica de un robot de Eurobot y tenerla en cuenta durante el diseño mecánico del mismo. El movimiento más común de un robot de Eurobot son los desplazamientos entre dos puntos. Durante dichos desplazamientos el robot parte de parado, recorre una distancia y vuelve a detenerse. Así, a cada desplazamiento le corresponde una fase de aceleración, una fase de velocidad constante y otra fase de frenado.

Para el caso de un robot con ruedas atrás y dos puntos de apoyo, el modelo dinámico del robot, según describe el equipo RCVA en \cite{rcva_10x}, queda representado por la figura siguiente:

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{dinamica_basica}
\caption[Modelo dinámico simple de un robot de tracción diferencial]{Modelo dinámico simple de un robot de tracción diferencial.}
\label{fig_dinamica_basica}
\end{figure}

Siendo:
\begin{description}
\item $F_n$: fuerza normal o vertical del suelo (opuesta a la fuerza de apoyo debida al peso del robot)
\item $F_x$: fuerza de propulsión de en la rueda
\item $F$: fuerza resultante del suelo en la rueda
\item $a$: aceleración del robot
\item $m$: masa del robot sobre las ruedas.
\end{description}

Durante la fase de aceleración ($a>0$) se necesita una fuerza de propulsión $F_x$ positiva de forma que la fuerza resultante $F$ provoque un desplazamiento hacia delante. Una vez alcanzada la fase de velocidad constante ($a=0$), teóricamente no es necesario realizar ninguna fuerza de propulsión\footnote{En la práctica, dado que existen perdidas por rozamiento $F_x$ no es nula. Aun así la fuerza para mantener una velocidad constante es menor que la necesaria para acelerar el robot hasta esa velocidad. El efecto es el mismo experimentado al mover un armario, una vez vencida la fuerza de rozamiento inicial la fuerza necesaria para desplazarlo es mínima.} y la fuerza resultante es igual a la fuerza normal sobre la rueda. En la última fase, la fuerza de tracción $F_x$ ha de ser negativa de forma que la fuerza resultante se oponga al movimiento del robot provocando una desaceleración o frenado.  

Para conseguir desplazamientos en un periodo de tiempo corto, las fases de aceleración y frenado han de durar lo menos posible. El valor de la aceleración durante esas fases va a depender por un lado del coeficiente de adherencia de las ruedas, y por otro, de la posición del centro de gravedad del robot.


\subsection{Coeficiente de adherencia de las ruedas y su cálculo experimental}
\label{coeficiente_adherencia_y_calculo_experimental}

A partir del modelo dinámico descrito anteriormente, teniendo en cuenta que el robot dispone de dos ruedas (un motor por rueda) y a partir de la primera ley de Newton ($F = ma$) se deduce que la aceleración sobre el eje horizontal del robot se corresponde con la expresión:
\begin{equation}
  \label{eq_a_f_fx}
  a = \frac{2F_x}{m}
\end{equation}


La aceleración máxima vendrá dada por la fuerza máxima de propulsión de las ruedas $F_{x\,max}$ a partir de la cual se produce el deslizamiento de las ruedas. Por lo tanto ha de cumplirse la condición
\begin{equation}
  \label{eq_condicion_fx}
   F_x<F_{x\,max}
\end{equation}

siendo
\begin{equation}
  \label{eq_fx_max_f_ka}
  F_{x\,max} = K_a \, F_n,
\end{equation}

donde $K_a$ es el coeficiente de adherencia de las ruedas contra el suelo y toma valores teóricos ente 0 y 1:

$K_a=0$: adherencia nula

$K_a=1$: adherencia teórica máxima\footnote{En la practica el coeficiente de adherencia puede superar valores de uno, por ejemplo si existe una carga aerodinámica extra como ocurre en los coches de carreras de la F1.}.

El valor de $K_a$ depende del tipo de neumático utilizado y de la calidad y limpieza del campo de juego. Así para un neumático consistente en una junta tórica se consiguen valores de $K_a$ inferiores a $0,5$. En cambio un neumático de caucho de baja dureza (entre 20 y 30 shores) podría alcanzar valores de $K_a$ cercanos a 1. 

%El coeficiente de adherencia permite calcular, junto con la posición del centro de gravedad del robot, la aceleración máxima del mismo. 
El valor del coeficiente de adherencia se puede medir experimentalmente mediante el método propuesto por Jacques Coulon en \cite{rcva_10x}, conocido como el \emph{método del cubo}. 

\begin{figure}[ht]
\centering
\includegraphics[width=\textwidth]{metodo_cubo}
\caption[]{Medodo de medida del coeficiente de adherencia de las ruedas.}
\label{fig_metodo_cubo}
\end{figure}


Dicho método se encuentra representado en la figura \ref{fig_metodo_cubo} y consta de tres pasos:

\begin{enumerate}
\item Apoyar las ruedas del robot sobre una báscula manteniendo el robot horizontal. Para ello, ayudarse de un soporte sobre los puntos de apoyo del robot. El peso $P1$ medido por la bascula se corresponde con la fuerza con la que las ruedas apoyan en el suelo.
\item Bloquear las ruedas del robot\footnote{El boqueo ha de ser un bloqueo mecánico, en caso de bloquear las ruedas manteniendo la consigna de posición del robot el motor puede resultar gravemente dañado.} y fijar a la parte más baja y cercana al eje motriz una cuerda atada a un cubo. Hacer pasar la cuerda por una polea para disminuir el rozamiento y añadir peso al cubo hasta que las ruedas comiencen a deslizar.
\item Medir el peso $P2$ del cubo, el cual se corresponde con la fuerza de tracción máxima en el límite de deslizamiento.
\end{enumerate}

El coeficiente de adherencia viene dado por las medidas realizadas según la expresión
\begin{equation}
  \label{eq_ka=f(p1,p2)}
  \boxed{K_a = \frac{P2}{P1}}.
\end{equation}

Notar que el valor de $K_a$ es independiente del peso del robot.

La validez de este método se ha comprobado en la practica. El método se aplicó a robots de diferente peso y de ruedas idénticas obteniendo los resultados de la tabla siguiente:


\begin{table}[ht]
\centering
\caption{Resultados de la medida del coeficiente de adherencia de las ruedas. La obtención de un valor mayor que $1,0$ para el caso del robot Zamorano se debe a la tolerancia de los objetos utilizados en el test del cubo. En ambos casos el valor se puede aproximar a la unidad.}
\label{tab_resultados_medida_ka}
\begin{tabular}{lccc}
\hline
Robot & $P1$ & $P2$ & $K_a$ \\
\hline
Zamorano (2011) 	& 14,5   & 15,6   & 1,076  \\
Automático (2012)   & 17,6   & 17,3   & 0,983  \\
\hline
\end{tabular}
\end{table}

Las ruedas de ambos robots se muestra en la figura \ref{fig_ruedas_foam_silicona}. Están construidas a partir de ruedas de coche de radio control de espuma, 60mm de diámetro y 45mm de ancho. Además se les ha añadido una capa de silicona para mejorar la adherencia. Este tipo de ruedas ha sido utilizado en todos los robots desarrollados desde el año 2011 dado su alto coeficiente de adherencia. 

\begin{figure}[h]
\centering
\includegraphics[height=.2\textheight]{ruedas_foam_silicona}
\caption[]{Ruedas utilizadas en los robots}
\label{fig_ruedas_foam_silicona}
\end{figure}


\subsection{Determinación de la aceleración máxima en las fases de aceleración y frenado}

La aceleración máxima durante las fases de aceleración o frenado depende de dos condiciones. La primera es la condición para la cual las ruedas derrapen o deslicen. Y la segunda, en caso de robots con ruedas atrás, es la condición para la cual el robot pierde contacto con el suelo en su parte delantera (como un caballo que se pone sobre sus patas trasera), pudiendo volcar hacia atrás.

Por otro lado, el valor de la aceleración máxima para cada condición depende del coeficiente de adherencia de las ruedas ($K_a$) y la posición del centro de gravedad del robot, respecto al eje motriz y los puntos de apoyo. 

A continuación describe como determinar el valor máximo de aceleración para los siguientes tipos de robot:

\begin{enumerate}
\item Robot con ruedas atrás
\item Robot con ruedas en el medio
\end{enumerate}

El desarrollo completo puede encontrarse en \cite{rcva_10x}. Aquí sólo se presentan los desarrollos que se han considerado importantes para el entendimiento la dinámica del robot y los resultados finales. Además, este trabajo añade el resultado para el caso de un robot con ruedas en el medio asimétrico, no estudiado en \cite{rcva_10x}.

\subsubsection{Robots con ruedas atrás}

Se parte del modelo dinámico del robot representado por la siguiente figura:

\begin{figure}[H]
\centering
\includegraphics[width=.4\textwidth]{dinamica_a_max_ruedas_atras}
\caption[]{Modelo dinámico en fase de aceleración y frenado para robots con ruedas atrás.}
\label{fig_dinamica_a_max_ruedas_atras}
\end{figure}

Donde:
\begin{description}
\item $G$: centro de gravedad del robot.
\item $F_x$: fuerza de propulsión de en la rueda.
\item $F1$: fuerza normal del suelo en la rueda.
\item $F2$: fuerza normal del suelo en el punto delantero.
\item $a$: aceleración del robot
\item $-mg$: fuerza de la gravedad aplicada en el centro de gravedad.
\item $d1$:  distancia entre el centro de gravedad y el eje motriz.
\item $d2$: distancia entre el centro de gravedad y el punto de apoyo delantero.
\item $d$: distancia entre el eje motriz y un punto de apoyo (d = d1 + d2).
\item $h$: altura del centro de gravedad del robot.
\end{description}

Las ecuaciones que garantiza que el sistema esta en equilibrio son las siguientes:	

\begin{description}
\item Suma de fuerzas verticales\\
\begin{equation}
\label{eq_suma_fuerzas_verticales}
2F1 + 2F2 - mg = 0
\end{equation}

\item Suma de fuerzas horizontales\\
\begin{equation}
\label{eq_suma_fuerzas_horizontales}
2F_x = ma
\end{equation}

\item Suma de torsiones aplicadas al punto G\\	
\begin{equation}
\label{eq_suma_torsiones_punto_g}
F2d2 - F1d1 + F_x \, h = 0
\end{equation}
\end{description}


A partir las ecuaciones \eqref{eq_suma_fuerzas_verticales}, \eqref{eq_suma_fuerzas_horizontales} y \eqref{eq_suma_torsiones_punto_g}	, se obtienen las ecuaciones que representan la distribución de pesos en las fases de aceleración y frenado:
\begin{align}
(2F1)/mg &= d2/d + (a/g)(h/d) \label{eq_distribucion_pesos_rueda}\\
(2F2)/mg &= d1/d - (a/g)(h/d) \label{eq_distribucion_pesos_apoyo}
\end{align}

Notar que el término $(2F1)/mg$ representa la distribución de pesos en el eje motriz, mientras que el termino $(2F2)/mg$ representa el reparto de pesos en la parte delantera. Los términos $d2/d$ y $d1/d$ representan las distribuciones de pesos en estático, cuando la aceleración es nula ($a=0$). Y el término  $(a/g)(h/d)$ representa la transferencia de masa del robot durante la aceleración o frenado.

Así pues, en fase de aceleración ($a>0$) la transferencia de masa se produce hacia la parte trasera del robot por lo que el robot avanza y tiende a hacer \emph{el caballito}. Mientras que en la fase de frenado ($a<0$) la transferencia de masa se produce hacia la parte delantera de forma que las ruedas tienen a deslizar o derrapar sobre el suelo.

Se deducen algunas conclusiones al respecto:

\begin{itemize}
\item Interesa tener el máximo apoyo en el eje motriz aumentando el termino $(2F1)/mg$ o el termino estático $d2/d$, de forma que el centro de gravedad esté lo más cerca posible del eje motriz.

\item Cuando el término de transferencia de masa dinámica $(a/g)(h/d)$ cambia de signo debido a la aceleración, se consiguen una buena fase de aceleración pero una fase peor de frenado.

\item Como los robots en un partido no hacer otra cosas que acelerar y frenar, interesa reducir lo máximo la transferencia de masa, la cual depende únicamente de la relación $(h/d)$. Por lo tanto interesa bajar el centro de gravedad lo máximo posible.
\end{itemize}


Continuando con el cálculo, la condición para no derrapar en la fase de aceleración viene dada por la ecuación \eqref{eq_fx_max_f_ka} expresada como 
\begin{equation}
\label{eq_condicion_derrape_aceleracion}
F_x < K_a \, F1
\end{equation}

y para la fase de frenado como
\begin{equation}
\label{eq_condicion_derrape_frenada}
|F_x| < K_a \, F1.
\end{equation}


Por otro lado, la condición para que el robot no haga \emph{el caballito} durante la fase de aceleración es
\begin{equation}
\label{eq_condicion_caballito_aceleracion}
F2 > 0
\end{equation}

y para la fase de frenado es
\begin{equation}
\label{eq_condicion_caballito_frenado}
F1 > 0
\end{equation}

A partir de las ecuaciones \eqref{eq_distribucion_pesos_rueda}, \eqref{eq_distribucion_pesos_apoyo}, \eqref{eq_suma_fuerzas_horizontales} y las condiciones mencionadas anteriormente se obtienen las aceleraciones máximas para cada fase y condición.

Fase de aceleración ($a>0$):
\begin{empheq}[box=\fbox]{align}
a_{max1} &= g\,\frac{K_a \, d2}{d-(K_a \, h)} \label{eq_a_max_aceleracion_derrape}\\
a_{max2} &= g\,\frac{d1}{h} \label{eq_a_max_aceleracion_caballito}
\end{empheq}


Fase de frenado ($a<0$):
\begin{empheq}[box=\fbox]{align}
a_{max1} &= g\,\frac{K_a \, d2}{d+(K_a \, h)} \label{eq_amax_frenado_derrape}\\
a_{max2} &= g\,\frac{d2}{h} \label{eq_amax_frenado_caballito}
\end{empheq}

Siendo $a_{max1}$ la aceleración máxima para no derrapar y $a_{max2}$ la aceleración máxima para no hacer \emph{el caballito}. Para cada fase, la aceleración máxima vendrá dada por el valor mínimo de estas:
\begin{equation}
\label{eq_a_aceleracion}
a_{max} = Min\{a_{max1}, a_{max2}\}.
\end{equation}


Por ejemplo, la figura \ref{fig_ejemplo_a_max} representa el caso de dos robots iguales excepto por la altura de su centro de gravedad.	

\begin{figure}[h]
\centering
\includegraphics[width=.8\textwidth]{ejemplo_a_max}
\caption[]{Ejemplo de cálculo de la aceleración máxima en las fases de aceleración y frenado}
\label{fig_ejemplo_a_max}
\end{figure}

Las aceleraciones máximas calculadas para estos robots se muestran en la tabla \ref{tab_ejemplo_a_max}.

\begin{table}[h]
\centering
\caption{Ejemplo de aceleraciones máximas en función del centro de gravedad}
\label{tab_ejemplo_a_max}

\begin{tabular}{ lcccc }
\hline
			& Aceleración R1 & Frenado R1 & Aceleración R2 & Frenado R2 \\
\hline
$a_{max1}$ 	& $1,2g$ 		& $0,4g$ 		& $3,0g$ 		& $0,3g$ 	\\
$a_{max2}$ 	& $0,8g$ 		& $1,2g$ 		& $0,5g$ 		& $0,75g$ 	\\
$a_{max}$ 	& $0,8g$ 		& $0,4g$ 		& $0,5g$ 		& $0,3g$ 	\\
			& ($8\,m/s$) 		& ($4\,m/s$) 		& ($5\,m/s$) 		& ($3\,m/s$)  \\
\hline
\end{tabular}

\end{table}

Observar que estos cálculos sólo se refieren a desplazamientos de translación y no a giros, permitiendo maximizar la aceleración. Que el robot sea capaz de alcanzar dicha aceleración va a depender de la elección de los motores y su reductora.

Por otro lado, hay que tener en cuenta que estos cálculos dependen únicamente del centro de gravedad del robot y del coeficiente de adherencia de las ruedas. El peso del robot no interviene.


\subsubsection{Robots con ruedas en el medio}

Un robot que tiene las ruedas en el medio puede ser que tenga su centro de gravedad exactamente sobre el eje motriz, de forma que el robot es simétrico. Si el centro de gravedad esta desplazado se habla de un robot asimétrico.

Los modelos dinámicos para estos casos se corresponden con la siguiente figura:

\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{dinamica_a_max_ruedas_medio}
\caption[]{Modelo dinámico fase de aceleración y frenado para robots con ruedas en el medio.}
\label{fig_dinamica_a_max_ruedas_medio}
\end{figure}

Donde:
\begin{description}
\item $G$: centro de gravedad del robot.
\item $F_x$: fuerza de propulsión de en la rueda.
\item $F1$: fuerza normal del suelo en la rueda.
\item $F2$: fuerza normal del suelo en el punto delantero.
\item $F3$: fuerza normal del suelo en el punto de apoyo trasero.
\item $a$: aceleración del robot
\item $-mg$: fuerza de la gravedad aplicada en el centro de gravedad.
\item $d1$: distancia entre el centro de gravedad y el eje motriz.
\item $d2$: distancia entre el centro de gravedad y el punto de apoyo trasero.
\item $d2'$: distancia entre el centro de gravedad y el punto de apoyo delantero.
\item $h$: altura del centro de gravedad del robot.
\end{description}

Para el caso del robot simétrico de la figura \ref{fig_dinamica_a_max_ruedas_atras} y siguiendo un análisis igual al realizado para robots con ruedas atrás, se obtienen las ecuaciones que definen las aceleraciones máximas. Debido a que el robot tiene 4 puntos de apoyo no es posible que éste haga \emph{el caballito}, por lo que la aceleración máxima vendrá dada únicamente para la condición de derrape de las ruedas y es la misma para las fases de aceleración y frenado dada la simetría del robot:
\begin{equation}
\label{eq_a_max_simetrico}
\boxed{a_{max} = g\,\frac{K_a}{1 + K_a\,(h/d2)}}
\end{equation}


Por otro lado, en el caso del robot asimétrico, el centro de gravedad cae entre el eje motriz y los puntos de apoyo de uno de los extremos del robot. Al igual que en el caso anterior la condición de hacer \emph{el caballito} no existe al tener el robot 4 puntos de apoyo. Sin embargo, la aceleración máxima es distinta para la fase de aceleración y la de frenado debido a la asimetría del robot.

Fase de aceleración ($a>0$):
\begin{equation}
\label{eq_a_max_pos_no_simetrico}
\boxed{a_{max} = g\,\frac{K_a}{(d1+d2)/d2 + K_a\,(h/d2)}}
\end{equation}


Fase de frenado ($a<0$):
\begin{equation}
\label{eq_a_max_neg_no_simetrico}
\boxed{a_{max} = g\,\frac{K_a}{(d2'-d1)/d2' + K_a\,(h/d2')}}
\end{equation}

Se comprueba que si $d1=0$, el modelo se corresponde con el de un robot simétrico y las ecuaciones \eqref{eq_a_max_pos_no_simetrico} y \eqref{eq_a_max_neg_no_simetrico} coinciden con la ecuación \eqref{eq_a_max_simetrico}.

\subsubsection{Medida del centro de gravedad del robot}

Se ha visto que para los cálculos de la aceleración máxima del robot es necesario conocer la posición del centro de gravedad del mismo. Su valor puede ser medido fácilmente utilizando una regla y una barra lo suficientemente larga. Por ejemplo para medir la altura del centro de gravedad se procedería a apoyar el robot sobre la barra por una de sus caras como muestra la figura \ref{fig_medida_centro_gravedad} hasta dar con una posición en la que el robot se encuentre en equilibrio. Una vez obtenida la posición de equilibrio se mide la distancia que hay de la base del robot al centro de la barra, la cual se corresponde con la altura del centro de gravedad. 

\begin{figure}[h]
\centering
\includegraphics[width=.4\textwidth]{medida_centro_gravedad}
\caption[]{Ejemplo de medida de la altura del centro de gravedad del robot}
\label{fig_medida_centro_gravedad}
\end{figure}

La operación se repite sobre la base del robot situando la barra paralela al eje motriz, de forma que se determina la distancia del centro de gravedad a dicho eje. Y por último, se puede realizar la medida con la barra situada perpendicularmente al eje motriz con el fin de comprobar que el robot es simétrico en dicho eje y que el peso soportado por cada rueda es el mismo.

\subsection{Perfil de velocidad trapezoidal}

Como ya se ha visto, el desplazamiento de un robot sobre un plano horizontal se divide en una fase de aceleración, otra de frenado y una fase intermedia de velocidad constante. Dichas fases se suelen implementar mediante un perfil trapezoidal de velocidad como el representado en la figura \ref{fig_perfil_trapezoidal}. 

\begin{figure}[h]
\centering
\includegraphics[width=.8\textwidth]{perfil_trapezoidal}
\caption[]{Fases de un perfil trapezoidal de velocidad: aceleración, velocidad y distancia recorrida}
\label{fig_perfil_trapezoidal}
\end{figure}

%En dicho perfil se pueden identificar las fases de aceleración, velocidad constante y frenado. A cada una de estas fases le corresponde una distancia recorrida ($d1,d2,d3$) y un tiempo ($t1,t2,t3$).

Como se sabe, la optimización de dicho perfil pasa por la determinación de las aceleraciones y velocidad máximas. La aceleración máxima se corresponde con aquella para la que el robot se encuentre al limite del deslizamiento o de hacer \emph{el caballito} y se calcula de la forma que se ha descrito en la sección anterior. En la práctica, nunca se trabaja con la aceleración máxima teórica y si no que se utiliza una aceleración de seguridad que suele se el 80\% de la teórica:
\begin{equation}
\label{eq_a_seguridad}
a = 0.8\,a_{max}
\end{equation}

Respecto a la velocidad máxima, dependerá en última medida del motor y la reductora utilizada. No obstante, dadas las dimensiones del campo y que los robots han de ser capaces de evitar colisiones entre ellos, una velocidad de $1m/s$ suele ser un buen valor de compromiso.

Resulta interesante el análisis que hacen en \cite{rcva_10x} sobre el valor de la velocidad máxima. En este análisis se comparan dos perfiles trapezoidales de distinta velocidad ($1m/s$ y $1,4m/s$), de igual aceleración ($a=2\,m/s$) y para una misma distancia recorrida ($1m/s$). El resultado es que el perfil con velocidad de $1,4m/s$ tarda sólo $0,1s$ menos en recorrer la distancia de $1m$. Un tiempo que es despreciable. Esto es debido a que el tiempo de la fase de velocidad constante del perfil de $1.4m/s$ es muy pequeño respecto al tiempo que se invierte en acelerar y frenar. De esto se deduce que para distancias cortas no es tan importante la velocidad como la aceleración del robot.

Por último,respecto a la gráfica de distancia del perfil trapezoidal, se observa una evolución parabólica durante las fases de aceleración y frenado que permite un movimiento suave del robot. Como se verá en la sección \ref{sec_control_posicion}, esta curva representa una consigna de distancia para el sistema de control de posición.

\subsection{Dimensionamiento de la reductora}

Como se sabe, las ruedas del eje motriz se encuentran conectadas al motor por medio de una reductora. El modelo mecánico de dicho sistema se muestra en la figura \ref{fig_modelo_reductora_motor}. 

\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{modelo_reductora_motor}
\caption[]{Modelo mecánico de uno de los motores del sistema de tracción diferencial.}
\label{fig_modelo_reductora_motor}
\end{figure}

Donde:
\begin{description}
\item $\omega_i$: velocidades angulares ($rad/s$)
\item $M_i$: par o momentos de fuerza ($N\,m$)
\item $P_i$: potencias mecánicas ($Nm/(rad/s)$)
\item $K$: relación de reducción de la reductora
\item $Rd$: rendimiento de la reductora
\item $D$: diámetro de la rueda
\end{description}

La potencia mecánica en el motor $P1$ y en el eje de salida de la reductora $P2$ viene dada como:
\begin{align}
P1 &= M1\,\omega1 \label{eq_potencia_mecanica_motor} \\
P2 &= M2\,\omega2 \label{eq_potencia_mecanica_reductora}
\end{align}

Dichas potencias se relacionan mediante la reductora de la siguiente manera:
\begin{align}
\omega2 &= \frac{\omega1}{K} \label{eq_relacion_w1_w1} \\
M2 &= M1\,Rd\,K \label{eq_relacion_M2_M1} \\
P2 &= P1\,Rd \label{eq_relacion_P2_P1} 
\end{align}

Observar que la relación entre potencias en \eqref{eq_relacion_P2_P1} no depende de $K$. Si $K$ aumenta el par de la reductora $M2$ aumenta pero la velocidad $w2$ disminuye.	

Por otro lado, del modelo del motor de corriente continua se sabe que la tensión de armadura del motor $U$ y el par motor $M$ vienen dados por las expresiones:
\begin{align}
U &= r\,i + K_v\,\omega \label{eq_tension_armadura} \\
M &= K_m\,i \label{eq_par_motor}
\end{align}

Siendo:
\begin{description}
\item $r$: resistencia de la armadura ($\Omega$)
\item $i$: corriente de la armadura (A)
\item $K_v:$ constante de fuerza electromecánica (V/(rad/s))
\item $K_m$: constante de par motor (Nm/A)
\end{description}

A la hora de dimensionar la reductora se busca determinar el valor de reducción ($K$) que genere un par suficiente en la rueda para vencer las fuerzas aplicadas en la misma que se oponen al movimiento.

No obstante existe una condición más restrictiva a la hora de dimensionar la reductora. Es el caso en el que las ruedas queden bloqueadas debido a que el robot se encuentra con un obstáculo imprevisto. Por ejemplo una pared debido a un error de posicionamiento, o que haya un objeto inesperado entre el robot y la pared. En ese caso el controlador de posición reaccionará aumentando la tensión del motor hasta su valor máximo $U_{max}$ (tensión de saturación $v_{sat}$) y se corre el riesgo de que el motor se queme. Este caso es analizado en \cite{rcva_10x} a partir de modelo térmico del motor. El análisis determina que en caso de bloqueo de una rueda la vida útil del motor es de 2,3s, a menos que el driver del motor sirva de fusible y se rompa antes o que exista un mecanismo de protección.

Teniendo en cuenta este caso, un dimensionamiento más correcto de la reductora es aquel que permita que las ruedas derrapen antes de que la tensión del motor alcance su valor máximo.

Por un lado se calcula el par en el motor $M1$ necesario para producir deslizamiento a partir del par en la rueda $M3$, el cual depende de a su vez la fuerza de propulsión máxima de las ruedas $F_{x\,max}$.
\begin{align}
M1 &= \frac{M3}{K\,Rd} \label{eq_M1} \\
M3 &= F_{x\,max}\,\frac{D}{2} \label{eq_M3} \\
F_{x\,max} &= \frac{K_a\,F1}{2} \label{eq_fx_max}
\end{align}

La fuerza aplicada sobre las ruedas $F1$ depende de la distribución de pesos sobre el eje motriz y se corresponde con el peso $P1$ medido durante el la medida experimental del coeficiente de adherencia $K_a$. De forma general $F1$ se calcula como:
\begin{equation}
F1 = mg\,\frac{d2}{d} \label{eq_F1}
\end{equation}

El par en el motor $M1$ resulta:
\begin{equation}
M1 = \frac{K_a\,mg\,(d2/d)}{K\,Rd\,D}
\end{equation}


Por otro lado, a partir de las ecuaciones del modelo del motor \eqref{eq_tension_armadura} y \eqref{eq_par_motor}, se obtiene el par máximo que puede dar el motor a la salida de la reductora $M2$ para la situación de bloqueo ($\omega = 0$):
\begin{align}
U &= U_{max} = v_{sat} \label{eq_v_{sat}} \\
i|_{\omega = 0} &= \frac{v_{sat}}{r} \label{eq_i_w_zero} \\
M2 &= K_m\,i = K_m\,\frac{v_{sat}}{r} \label{eq_M2}
\end{align}


La condición que garantiza el deslizamiento de las ruedas en una situación de bloqueo es que el par máximo del motor sea mayor que el par en el límite de deslizamiento de la rueda. Para asegurar dicha condición se añade un margen de un 20\% de forma que el deslizamiento sea apreciable:
\begin{equation}
M2 >= 1,2\,M1 \label{eq_condicion_kmin}
\end{equation}

El valor mínimo de la reductora $K_{min}$ se obtiene al sustituir \eqref{eq_M1} y \eqref{eq_M2} en \eqref{eq_condicion_kmin} y despejar $K$:
\begin{equation}
\boxed{K_{min} = 1,2\,\frac{K_a\,mg\,(d2/d)\,D\,r}{4\,K_m\,Rd\,v_{sat}}} \label{eq_kmin}
\end{equation}

Notar que $K_{min}$ aumenta si los términos $K_a\,F1$, $D$ o $r$ aumentan, o $K_m$, $U_{max}$ disminuye.

Por ejemplo, el sistema de tracción diferencial de la plataforma desatollada utiliza unos motores \emph{brushless} Dunkermotoren BG40x50 alimentados a 24V de 30W. Aunque no se trata de un motor de corriente continua se sabe por \cite{bercerra14} que se puede modelizar como tal y que su funcionamiento queda representado por las mismas curvas del motor de continua como muestra la figura \ref{fig_motor_bg40x50_curvas}

\begin{figure}[h]
\centering
\includegraphics[width=.8\textwidth]{motor_bg40x50_curvas}
\caption[]{Curvas del motor Dunkermotoren BG40x50 24V dada por el fabricante.}
\label{fig_motor_bg40x50_curvas}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=.6\textwidth]{motor_bg40x50_tabla}
\caption[]{Parámetros del motor Dunkermotoren BG40x50 24V dadas por el fabricante.}
\label{fig_motor_bg40x50_tabla}
\end{figure}

A partir de los parámetros y curvas dadas por el fabricante (ver figura \ref{fig_motor_bg40x50_tabla} y \ref{fig_motor_bg40x50_curvas}) se deducen las variables necesarias para el cálculo de la reductora. La resistencia equivalente se obtiene de \eqref{eq_tension_armadura} a partir del la tensión nominal $U_n$ y la corriente de arranque $i_o$ como

$$r = \frac{U_n}{i_o} = \frac{24V}{8,4A} = 2,86\Omega$$

Por otro lado la constante mecánica $K_m$ se obtiene a partir de la pendiente de la recta $i=f(M)$ de la figura \ref{fig_motor_bg40x50_curvas} los puntos $(M_n, i_n)$ y $(M_o, i_o)$ como:

$$ K_m = \frac{M_o - M_n}{i_o - i_n} =  \frac{(37,4-8)[Ncm]}{(8,4-2,1)[A]} \times \frac{1[m]}{100[cm]} = 46,7 mN\,m/A $$

Además según el fabricante las reductoras compatibles para éste motor tienen un rendimiento $Rd$ de un 90\% hasta valores de $K=8$


Para el caso del robot P.Tinto (Eurobot 2015) sus datos son:
\begin{align*}
m &= 15 Kg\\
D &= 0,6 m\\
d &= 0,131 m\\
d2 &= 0,112 m\\
K_a &= 1\\
V_{bat}&= 24V
\end{align*}

Por último, sustituyendo en \eqref{eq_kmin} se obtiene un valor de 
$$K_{min} = 6,37.$$ 
Puesto que es menor que 8 el rendimiento utilizado de la reductora es válido. La reductora del fabricante de valor cercano por exceso es la reductora PLG42S 8:1. 

En el caso real, ya se disponían de estos motores y además ya venían con una reductora PLG42S de factor de reducción 4:1\footnote{Estos motores se compraron en el año 2010 a un vendedor de eBay. Los motores nuevos son caros y por que entonces no había presupuesto suficiente para comprar unos nuevos a demanda de los requisitos del robot.}. Se optó por añadir una segunda etapa de reducción. Esta segunda etapa se implemento mediante una reducción por correa dentada, cuyo rendimiento es del 90\%. Recalculando $K_{min}$ para un rendimiento de $0,9²$ se obtiene una 
$$K_{min} = 7.$$	

A partir de este valor, se escogió un factor de reducción 2:1 para la segunda etapa obteniendo un factor de reducción total de 8:1.

\subsection{Calculo de la velocidad máxima}

Asumiendo que los motores del robot tienen asociado un controlador de posición o velocidad, el dimensionamiento de estos se realiza de forma que el controlador no llegue nunca a la tensión de saturación. Esto es, la tensión $U$ de los motores ha de estar por debajo de la tensión de saturación $v_{sat}$. Interesa conocer cual es el margen entre estas dos tensiones necesario para realizar un control sobre los motores sin bloqueos.

El análisis a realizar parte de la premisa de utilizar un perfil de velocidad trapezoidal. Para ello se considera que el perfil de velocidad constituye una consigna de velocidad para el controlador \cite{rcva_10x}.

El análisis parte del perfil perfil de velocidad representado en la figura \ref{fig_dimensionamiento_motores} y de las ecuaciones que describen el modelo del motor de continua
\begin{align}
U &= r\,i + K_v\,\omega,\label{eq_tension_armadura2} \\
M &= K_m\,i \label{eq_par_motor2}
\end{align}


\begin{figure}[h]
\centering
\includegraphics[width=.7\textwidth]{dimensionamiento_motores}
\caption[]{Tensión de armadura del motor en el límite de saturación para un perfil de velocidad trapezoidal.}
\label{fig_dimensionamiento_motores}
\end{figure}

Se observa que durante las fases de aceleración y frenado la aceleración del robot es constante, por lo que el par motor\footnote{$M=F\times\,d = m\,a\times\,d$. Si $a=\text{cte}$, $M=\text{cte}$} y la corriente son constantes\footnote{$M=K_m\,i$. Si $M=\text{cte}$, $i=\text{cte}$}. La tensión de armadura $U$ del motor es la suma del termino óhmico $r\,i$ y del termino de velocidad angular $K_v\,\omega$. Por lo tanto durante las fases de aceleración y frenado, el término óhmico será constante y el término de velocidad proporcional a esta. De esta forma el valor máximo de la tensión de armadura del motor $U$ se alcanza, al final de la fase de aceleración, en el instante $t1$.

Por otro lado, hay que recordar que el cálculo de la reductora también se realiza en base a la tensión de saturación $V_{sat}$, para la cual las ruedas comenzarían a deslizar para evitar el bloqueo del motor. Es por ello que el instante $t1$ constituye el punto más crítico de las fases del perfil trapezoidal.

El límite de funcionamiento sin saturación es dado por la ecuación \eqref{eq_tension_armadura2}, valida en el instante $t1$. Por un lado, la corriente de armadura $i$ se puede expresar en función de la aceleración $a$ del robot del siguiente modo:
\begin{equation}
\begin{split}
i &= \frac{M1}{K_m}\\
M1 &= \frac{M3}{K\,Rd}\\
M3 &= Fx\,\frac{D}{2}\\
2Fx &= m\,a \label{eq_desarrollo_i_func_a}
\end{split}
\end{equation}

Por otro lado, la velocidad angular $\omega$ se puede expresar en función de la velocidad $v$ del robot como:
\begin{equation}
\begin{split}
\omega1 &= K\,\omega3\\
v &= \frac{2\omega3}{D} \label{eq_w_func_v}
\end{split}
\end{equation}

Sustituyendo los desarrollos \eqref{eq_desarrollo_i_func_a} y \eqref{eq_w_func_v} en \eqref{eq_tension_armadura2} se obtiene\footnote{$K_v$ ha sido sustituido por $K_m$ ya que coinciden si ambas constantes se expresan en $[V/(rad/s)]$ y $Nm/A$, respectivamente}:
\begin{equation}
U = \Big(\frac{r\,m\,D}{4K\,Rd\,K_m}\Big)\,a + \Big(\frac{2K_m\,K}{D}\Big)\,v \label{u_func_a_v}
\end{equation}

Representando la velocidad $v$ en función de la aceleración $a$ se obtiene la ecuación de la recta 
\begin{equation}
v = v_o - \frac{v_o}{a_o}\,a \label{v_func_a}
\end{equation}

Donde
\begin{align}
v_o &= \frac{\,U\,D}{2K\,K_m} \label{v_o} \\ 
a_o &= \frac{4K\,U\,Rd\,K_m}{r\,D\,m} \label{a_o}
\end{align}

Dicha recta se representa en la figura \ref{fig_recta_velocidad_maxima}, donde se puede observar que la aceleración máxima $a_{max}$ define la zona útil de funcionamiento sin saturación y deslizamiento. 

\begin{figure}[p]
\centering
\includegraphics[width=.65\textwidth]{recta_velocidad_maxima}
\caption[]{Recta de velocidad máxima para una aceleración dada y zona útil de funcionamiento sin saturación y deslizamiento.}
\label{fig_recta_velocidad_maxima}
\end{figure}

\begin{figure}[p]
\centering
\includegraphics[width=.7\textwidth]{recta_velocidad_maxima_ptinto}
\caption[]{Velocidad y aceleración del robot P.Tinto para un funcionamiento sin saturación y deslizamiento.}
\label{fig_recta_velocidad_maxima_ptinto}
\end{figure}

Recapitulando y simplificando \eqref{v_func_a}, la velocidad máxima del robot $v_{max}$ al límite de saturación y deslizamiento para una aceleración dada se obtiene a partir de la expresión
\begin{empheq}[box=\fbox]{align}
v_{max} &= v_o\, (1-\frac{a_{max}}{a_o}) \label{v_max_func_a_max}\\
v_o &= \frac{\,U\,D}{2K\,K_m} \label{v_o} \\ 
a_o &= \frac{4K\,U\,Rd\,K_m}{r\,D\,m} \label{a_o}
\end{empheq}

Siguiendo con el ejemplo del dimensionamiento de la reductora del robot P.Tinto, a partir de los datos ya conocidos del motor Dunkermotoren BG40x50 y de las expresiones \eqref{v_o} y \eqref{a_o}, se obtiene la recta velocidad-aceleración representada en la figura \ref{fig_recta_velocidad_maxima_ptinto} donde 
\begin{align}
v_o &=  1,93 m/s \label{v_o_ptinto} \\ 
a_o &=  11,29 m/s^2\,\,(1,15g)\label{a_o_ptinto}
\end{align}

P.Tinto es un robot tipo con ruedas en el medio no simétrico como el de la figura \ref{fig_dinamica_a_max_ruedas_medio}. A partir del coeficiente de adherencia de las ruedas $K_a = 1$ y las medidas del centro de gravedad respecto al eje motriz:
\begin{equation}
\begin{split}
d1 &= 19,18 mm\\
d2 &= 111,8 mm\\
d2' &= 139,68 mm\\
h &= 122,9 mm
\end{split}
\end{equation}

Mediante las ecuaciónes \eqref{eq_a_max_neg_no_simetrico} y \eqref{eq_a_max_pos_no_simetrico} se determina una aceleración máxima 
\begin{equation}
a_{max} = 0,44g\,\,(4,32m/s²)
\end{equation}

Teniendo en cuenta un margen de seguridad del 20\% se fija la aceleración del robot a un valor de $0,35g$ ($3,45 m/s^2$). A partir de la ecuación \eqref{v_max_func_a_max} se obtiene la velocidad correspondiente para un funcionamiento sin saturación y deslizamiento:
\begin{equation}
v_{max} = 1,2 m/s
\end{equation}


Se ha representado una segunda recta en la figura \ref{fig_recta_velocidad_maxima_ptinto} correspondiente a un motor de la mitad de potencia. Observar que para una misma aceleración la velocidad es menor. En el primer caso la velocidad es superior a la velocidad deseada ($1 m/s$) y el motor BG40x50 es válido, mientras que en el segundo caso el motor no sería valido.

La gráfica de la figura \ref{fig_perfil_vmax_amax} muestra el resultado de aplicar un perfil trapezoidal cuya velocidad es la máxima calculada. Observar que para la velocidad máxima calculada al final de la fase de aceleración (instante $t1$ de la figura \ref{fig_dimensionamiento_motores}) la tensión de control de los motores se encuentra muy cerca de su valor de saturación (63500 cuentas, que equivale al 100\% de ciclo de trabajo de una señal PWM). Si se disminuye la velocidad hasta $0,8m/s$, el valor de la tensión baja hasta el $80\%$ de su máximo, como muestra la figura \ref{fig_perfil_v08_amax}.

\begin{figure}[p]
\centering
\includegraphics[width=\textwidth]{perfil_vmax_amax}
\caption[]{Señal de control de los motores para un perfil de velocidad trapezoidal de $1,2m/s$ y una aceleración de $3,45m/s$}
\label{fig_perfil_vmax_amax}
\end{figure}

\begin{figure}[p]
\centering
\includegraphics[width=\textwidth]{perfil_v08_amax}
\caption[]{Señal de control de los motores para un perfil de velocidad trapezoidal de $0,8m/s$ y una aceleración de $3,45m/s$}
\label{fig_perfil_v08_amax}
\end{figure}



%\subsection{Resultados experimentales}
%\vfill
%\newpage

\section{Control en posición de tipo polar}
\label{sec_control_posicion}

La plataforma robótica base implementa un control de posición de tipo polar. Este tipo de control es muy  utilizado por los robots de Eurobot y es el que mejor se adapta a este tipo de aplicación, ya que, en ultima medida el robot ha de ser capaz de llegar a posiciones específicas del campo donde manipular elementos de juego. Así mismo, este tipo de control de posición ha sido muy comentado en los foros de Eurobot \cite{foros_eurobot}, documentado \cite{rcva_10x} \cite{rcva_asserv} e implementado por muchos equipos \cite{microb}.

La posición del robot viene dada por una consigna de distancia $d$ y de una consigna de orientación o ángulo $a$, correspondientes a un controlador de distancia y un controlador de ángulo. El control de posición polar permite obtener un mejor rendimiento que un controlador de posición por rueda del robot (ver figura \ref{fig_control_polar_vs_por_rueda}).

\begin{figure}[ht]
\centering
\includegraphics[width=.75\textwidth]{control_polar_vs_por_rueda}
\caption[]{Control de posición polar vs. control independiente de posición por rueda}
\label{fig_control_polar_vs_por_rueda}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[width=\textwidth]{control_polar}
\caption[]{Diagrama de bloques del control de posición polar}
\label{fig_control_polar}
\end{figure}

El diagrama de bloques del controlador polar se muestra en la figura \ref{fig_control_polar}. En cada controlador error de posición $e[n]$ se obtiene a partir de la resta de la consigna $x[n]$ y de la medida instantánea de los encoders $y[n]$ en cada periodo de muestreo $T_s$. Para el caso del control en distancia, $y[n]$ se corresponde con la distancia recorrida por el robot y se obtiene a partir del valor medio de la distancia recorrida por cada encoder. Mientras que en el caso del controlador en ángulo, $y[n]$ se corresponde con el ángulo instantáneo del robot y se obtiene a partir de la diferencia de la distancia recorrida por los encoders.

El error de consigna es procesado por un controlador PID (Proporcional Integral Derivativo) generando a su salida la señal de control $u[n$] para los motores. Notar que en el caso del controlador de distancia la señal de control es la misma para ambos motores, mientras que en el caso del controlador de ángulo, el signo de la señal de control del motor izquierdo se encuentra invertida.

En la practica, se ha utilizado un controlador PD frente al clásico PID, esta elección viene dada por el balance entre las ventajas e inconvenientes del termino integral.

Ventajas:
\begin{itemize}
\item Mejor precisión en régimen permanente
\item Mejor respuesta a perturbaciones
\end{itemize}

Desventajas:
\begin{itemize}
\item Tendencia a desestabilizar el bucle de control
\item Introduce el fenómeno de \emph{windup}\footnote{Efecto por el cual el controlador puede saturarse dando como resultado respuestas bruscas no lineales en el momento que la perturbación cesa}.
\end{itemize}

El termino integral suele ser utilizado en procesos industriales donde la respuesta a perturbaciones es muy importante. Sin embargo, para un robot de Eurobot su uso puede ser cuestionable tal y como se argumenta en \cite{rcva_10x}. Esto es debido a las posibles reacciones bruscas del efecto \emph{windup} y a que en Eurobot una perturbación significa que el robot se ha bloqueado debido a que ha chocado con un oponente o una pared. En dicho caso, si la reductora del robot se ha dimensionado correctamente, las ruedas derraparan, por lo que el termino integral no tendrá ningún efecto.

Al utilizar una arquitectura PD el sistema de control es tipo 1 \cite{ogata2010}. Por un lado, esto implica que un ajuste más sencillo de los controladores. Hay que tener en cuenta que un controlador tipo 1 siempre tendrá un mejor rendimiento y fiabilidad que un controlador tipo 2 mal ajustado. Por otro lado, un sistema de control de tipo 1 implica un error de posición nulo ante una entrada tipo escalón y un error de velocidad constante ante una entrada tipo rampa. Teniendo en cuenta que las consignas de los controladores de posición vendrán dadas a partir de perfiles de velocidad trapezoidal, durante las fases de aceleración y frenado el controlador seguirá a la consigna a la misma velocidad pero con un retardo constante, mientras que durante la fase de velocidad constante o en estado de reposo (robot parado) el error de posición será nulo. Dado que es en distancia donde se requiere un control preciso, el retardo en velocidad es un factor asumible.

Respecto a la acción derivativa de un controlador PID o PD, esta suele introducir cierto ruido en la señal de control de los motores $u[n]$ y da como resultado un controlador más nervioso. Este ruido puede reducirse mediante un controlador del tipo PI-D \cite{ogata2010} donde la corrección derivativa se realiza directamente a partir de la medida de los encoders. Este caso ha sido estudiado en \cite{rcva_10x}, donde se comprueban las ventajas de un controlador P-D frente a una arquitectura clásica PD. Efectivamente, la señal de control $u[n]$ es menos ruidosa y de un valor de pico menor, lo que repercute en un control más suave de la velocidad del robot. Además se observa que el error $e[n]$ del controlador P-D es menor que en el PD. Por contra, se observa un retardo mayor en las fases de aceleración y frenado para en controlador P-D, consiguiendo la misma aceleración para ambas arquitecturas.

Otra opción para disminuir el efecto del termino integral consiste en asignar un periodo de muestreo para el termino derivativo $T_d$ menor que el periodo de muestreo del bucle $T_s$, de forma que, el el error derivativo quede promediado y se consigua una respuesta más suave a la salida del controlador.

\subsection{Implementación del perfil de velocidad trapezoidal}

La implementación del perfil de velocidad trapezoidal se consigue mediante un filtro de consigna previo a la consigna de distancia y ángulo de los controladores (ver figura \ref{fig_filtro_consigna}). Dado que lo que se quiere limitar es la aceleración y la velocidad con la que varia la consigna de posición se necesita de un filtro de segundo orden. Dicho filtro evalúa la primera y segunda derivada de la consigna de posición $x[n]$, correspondientes a la aceleración y velocidad máximas. En caso de superase alguna de ellas la consigna de posición a la salida del filtro $x'[n]$ es limitada al valor de la aceleración o la velocidad máxima, según aplique.

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{filtro_consigna}
\caption[]{Implementación del perfil de velocidad trapezoidal mediante un filtro de consigna}
\label{fig_filtro_consigna}
\end{figure}


\subsection{Sistema de unidades del robot}

Los controladores de posición a implementar trabajan en unidades diferentes a las del sistema internacional (SI). A la hora de establecer la consigna de los mismos o fijar la velocidad y aceleración máxima del filtro de consigna es necesario conocer los coeficientes de conversión entre ambos sistemas de unidades. La tabla \ref{tab_unidades_robot} muestra las unidades de la distancia, velocidad y aceleración para el sistema internacional y el sistema de unidades del robot.

\begin{table}[h]
\centering
\caption{Unidades SI y del sistema robot}
\label{tab_unidades_robot}

\begin{tabular}{ lccc }
\hline
Magnitud	& Simbolo   & Unidades SI 	& Unidades sistema Robot \\
\hline
Distancia 	& $d$ 		& $m$  			& $pulsos$ \\
Velocidad 	& $v$		& $m/s$			& $pulsos/T_s$\\
Aceleración & $a$		& $m/s^2$		& $pulsos/T_s^2$ \\
\hline
\end{tabular}
\end{table}

Los coeficientes de conversión de distancia $C_d$, velocidad $C_v$ y aceleración $C_a$ entre sistemas se calculan como:
\begin{align}
C_d &= \frac{N\times M}{\pi\,D_n} \,\Big[\frac{pulsos}{m}\Big] \\
C_v &= C_d\, T_s 				  \,\Big[\frac{pulsos/T_s}{m/s}\Big] \\
C_a &= C_d\, T_s^2  			  \,\Big[\frac{pulsos/T_s^2}{m/s^2}\Big]
\end{align}

Siendo:
\begin{align*}
N &: \text{Numero de pulsos por vuelta de encoder} \\
M &: \text{Factor de multiplicación de decodificación de señales en cuadratura del encoder} \\
D_n &: \text{Diámetro nominal del encoder} \\
T_s &: \text{Periodo de muestreo}
\end{align*}

De esta forma dada una distancia $d$, velocidad $v$ y aceleración $a$ en unidades del SI su valor en unidades del robot serian:
\begin{align}
d_r &= C_d\,d \\
v_r &= C_v\,v \\
a_r &= C_a\,a \\
\end{align}

Por ejemplo para los datos, correspondientes al robot P.Tinto (Eurobot 2015):
\begin{align*}
N &= 3600\,pulsos \\
M &= 4 \\
D_n &= 55\,mm \\
T_s &= 5\,ms 
\end{align*}

Se obtienen las constantes
\begin{align*}
C_d &= 83339,121 \\
C_v &= 416,696 \\
C_a &= 2,083
\end{align*}

Así por ejemplo, para una distancia de $1m$, una velocidad de $1m/s$ y una aceleración de $3,6m/s^2$ se obtiene:
\begin{align}
d_r &= C_d\, 1 = 83339,121 \\
v_r &= C_v\, 1 = 416,696 \\
a_r &= C_a\,a 3 = 7,501
\end{align}

Se observa que los valores resultantes son decimales, lo cual implicaría trabajar con decimales en la implementación de los controladores. Esto no es nada óptimo desde el punto de vista de procesamiento digital. Una posible solución pasa por redondear dichos valores para poder trabajar con números enteros, pero para valores pequeños como el de la aceleración el error por redondeo podría ser considerable. Para solucionar dicha perdida de precisión se añade un factor $K_{imp}$:
\begin{align}
C_d &= K_{imp}\,\frac{N\times M}{\pi\,D_n} \,\Big[\frac{pulsos}{m}\Big] \\
C_v &= K_{imp}\,C_d\, T_s 				  \,\Big[\frac{pulsos/T_s}{m/s}\Big] \\
C_a &= K_{imp}\,C_d\, T_s^2  			  \,\Big[\frac{pulsos/T_s^2}{m/s^2}\Big]
\end{align}

Por ejemplo, para un $K_{imp}=10$ el valor de la consigna de aceleración seria $a_r=75$ lo que equivale a un error menor del 1\%.

Para que la conversión sea válida, el factor $K_{imp}$ ha de integrarse en el controlador. Como muestra la figura \ref{fig_control_polar_kimp}, la integración se realiza en el lazo de realimentación de forma que el factor $K_{imp}$ multiplica a la medida de posición de los encoders. Notar que la constante $K_{imp}$ no tiene efecto sobre la medida de ángulo.

\begin{figure}[ht]
\centering
\includegraphics[width=\textwidth]{control_polar_kimp}
\caption[]{Integración del factor $K_{imp}$ en el diagrama de bloques del control de posición polar}
\label{fig_control_polar_kimp}
\end{figure}

\subsection{Ajuste del controlador de posición}

El método de ajuste utilizado es experimental, al igual que otros métodos experimentales como los basados en las reglas de Ziegler-Nichols \cite{ogata2010}, permiten obtener una estimación razonable de los parámetros del controlador y proporcionan un punto de partida para una sintonía fina. 

Independientemente del método utilizado, para conseguir un ajuste preciso de los controladores es indispensable contar con una herramienta de depuración que permita adquirir las diferentes señales del diagrama de control y poder representarlas. Por ejemplo, la plataforma desarrollada cuenta con una interfaz serie RS-232 por la cual se vuelcan los datos durante el proceso de ajuste de los controladores.

El proceso de ajuste utilizado es el propuesto en \cite{rcva_10x}. A la hora de llevarlo a cabo es aconsejable primero en ajustar el controlador de ángulo y posteriormente el de distancia. Esto es debido a que durante el proceso de ajuste del controlador de ángulo se llevan a cabo ciertas secuencias de rotación, que luego son secuencias de desplazamiento en el caso del controlador de distancia. Si en este último caso el controlador de ángulo no está previamente ajustado, durante el proceso de ajuste del controlador de distancia habrá desviaciones laterales que dificultarían el proceso.

Primero para ajustar el controlador de ángulo se bloquea el controlador de distancia fijando una consigna de valor 0. Y luego, para ajustar el controlador de distancia se hace lo contrario, y se fija una consigna de ángulo igual a 0. El ajuste de ambos controladores se hace sin ningún tipo de perfil o rampa de velocidad, se busca observar la respuesta a una perturbación tipo escalón. 

Para cada controlador se ajusta primero el termino proporcional, luego el termino derivativo y por último, si corresponde, el termino integral. En este caso se presenta el proceso de ajuste de un controlador PD.

\begin{enumerate}
\item Ajuste del termino proporcional $K_p$:
	\begin{enumerate}
	\item Anular la corrección derivativa $K_d=0$.
	\item Fijar una ganancia $K_p$ inicial.
	\item Saca al controlador de su posición de equilibrio. Desplazamientos entre 5 y 10 grados en ángulo, o $5cm$ en distancia.
	\item Observar las gráficas de la respuesta del controlador.
	\item Incrementar el valor de $K_p$ hasta observar en las gráficas una respuesta amortiguada de duración entre 1 y 2 segundos.
	\end{enumerate}

\item Ajuste del termino derivativo $K_d$:
	\begin{enumerate}
	\item Fijar una ganancia $K_d$ inicial.
	\item Saca al controlador de su posición de equilibrio. Desplazamientos entre 5 y 10 grados en ángulo, o $5cm$ en distancia.
	\item Observar las gráficas de la respuesta del controlador.
	\item Incrementar el valor de $K_d$ hasta observar en las gráficas que se obtiene una respuesta sin oscilaciones amortiguadas correspondiente hasta llegar una respuesta subamortiguada con un sobreimpulso $M_p$ cercano al $4.6\%$ ($\xi=0,7$).
	\end{enumerate}
\end{enumerate}

La figuras \ref{fig_ajuste_kp_figure_2} y \ref{fig_ajuste_kd_figure_2} muestra las gráficas obtenidas una vez realizado el ajuste de los términos del controlador de distancia.

Una vez ajustados ambos controladores es posible realizar un ajuste fino de los mismos con el fin de obtener un tiempo de establecimiento. Siguiendo el mismo procedimiento descrito para el ajuste, se incrementa el termino $K_p$ en un 20\% y se vuelve a ajustar el termino derivativo. Se repite esta operación sucesivamente hasta el momento en el que el termino $K_d$ no sea capaz de compensar el incremento de $K_p$ poniendo atención en que la señal de control del motor $u[n]$ no sature.

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{ajuste_kp_figure_2}
\caption[]{Resultado del ajuste del termino proporcional $K_p$ del controlador de distancia ante una consigna tipo escalón de $5cm$}
\label{fig_ajuste_kp_figure_2}
\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{ajuste_kd_figure_2}
\caption[]{Resultado del ajuste del termino proporcional $K_d$ del controlador de distancia ante una consigna tipo escalón de $5cm$}
\label{fig_ajuste_kd_figure_2}
\end{figure}


Por último, se realiza un último ajuste de los controladores a aplicando la consigna dada por el perfil de velocidad trapezoidal. En este último ajuste se busca obtener una fase de aceleración y frenado óptimo. Para ello se ha de prestar atención en que durante y al final de cada una de estas fase no existan variaciones bruscas de la posición del robot que puedan causar sobre impulsos de aceleración superiores a la aceleración máxima. Esto es, que la posición se ciña a la forma del perfil lo máximo posible. En las figuras \ref{fig_ajuste_perfil_1} y \ref{fig_ajuste_perfil_2} se muestra el resultado de ajustar el controlador de distancia con un perfil trapezoidal.


\begin{figure}[p]
\centering
\includegraphics[width=\textwidth]{ajuste_kp_kd_perfil_figure_2}
\caption[]{Resultado del ajuste del controlador de distancia aplicando un perfil de velocidad trapezoidal ($a=3,45m/s^2$, $v=0,8m/s$).}
\label{fig_ajuste_perfil_1}
\end{figure}

\begin{figure}[p]
\centering
\includegraphics[width=\textwidth]{ajuste_kp_kd_perfil_figure_1}
\caption[]{Resultado del ajuste del controlador de distancia aplicando un perfil de velocidad trapezoidal ($a=3,45m/s^2$, $v=0,8m/s$)}
\label{fig_ajuste_perfil_2}
\end{figure}

% TODO someday
%\subsection{Compensación de la gravedad}
%\subsection{Estimación de bloqueos mecánicos en el lazo de controlador}

\pagebreak
\section{Posicionamiento mediante odometría}

La odometría es el método más usado para determinar la posición momentánea de un robot. Dicha posición viene dada en un plano cartesiano por sus coordenadas absolutas $(x,y,\theta)$ correspondientes a la distancia al origen de coordenadas y al ángulo respecto al eje de abscisas. 

\subsection{Calculo de la posición del robot}

El sistema desarrollado para implementar este tipo de posicionamiento es el sistema de ruedas libres descrito en la sección \ref{sec_sma_posicionamiento_y_control}. Los principales elementos de este sistema y las dimensiones relacionada con la implementación de este método se muestra en la figura \ref{fig_odometria_dimensiones} donde $D_n$ se corresponden con el diámetro nominal de las ruedas de los encoders y $b$ con la distancia entre ejes de rueda de encoder.

\begin{figure}[ht]
\centering
\includegraphics[width=.4\textwidth]{odometria_dimensiones}
\caption[]{Representación en planta del robot. Componentes y dimensiones implicas en la odometría}
\label{fig_odometria_dimensiones}
\end{figure}

La determinación de la posición $(x,y,\theta)$ del robot se obtiene a partir la medida del incremento de pulsos de cada encoder por periodo de muestreo $Ts$. A partir de la medida en un periodos de muestreo de los pulsos del encoder derecho $N_D$ e izquierdo $N_I$ se obtiene la medida de instantánea de distancia $d$ y ángulo $\theta$ en cada periodo de muestreo como:

\begin{align}
d = \frac{N_D + N_I}{2}\, [pulsos] \label{eq_d_pulsos}\\
\theta = (N_D - N_I)\, [pulsos] \label{eq_angle_pulsos}
\end{align}

La conversión de unidades del robot a unidade del SI se realiza multiplicando dichas medidas por los factores de conversión de distancia $C_d$ y angulo $C_\theta$, calculados como:

\begin{align}
C_d &= \frac{N\times M}{\pi\,D_n} \,\Big[\frac{pulsos}{m}\Big] \label{eq_coef_d}\\
C_\theta &= C_d\,\frac{b}{2} \Big[\frac{pulsos}{rad}\Big] \label{eq_coef_angle}
\end{align}

Por un lado, la coordenada $\theta$ del robot puede obtenerse directamente de la equación \eqref{eq_angle_pulsos} como:

\begin{align}
\boxed{\theta_n = \frac{N_{D\,n} - N_{I\,n}}{C_\theta} [rad]} \label{eq_angle_rad}
\end{align}


Por otro lado, las coordenadas $(x,y)$ se calculan a partir del analisis de la trayectoria del robot muestreada para dos instantes consecutivos (ver figura \ref{fig_odometria_geometria}). Las posiciones A y B se corresponden con los instantes $n$ y $n-1$ a los que les corresponde una medida de angulo $\theta_n$ y $\theta_{n-1}$ y una medida de distancia $d_n$ y $d_{n-1}$. La distancia curvilínea entre los puntos A y B es $L$ y su proyección sobre los ejes $dx$ y $dy$. 

\begin{figure}[ht]
\centering
\includegraphics[width=.5\textwidth]{odometria_geometria}
\caption[]{Representación geométrica de dos puntos de una trayectoria}
\label{fig_odometria_geometria}
\end{figure}

Las coordenadas $(x,y)$ en un instante dado se corresponden con:

\begin{align}
x_n &= x_{n-1} + dx \\
y_n &= y_{n-1} + dy \\
\end{align}

En teoría la obtención de las proyecciones $dx$ y $dy$ resulta imposible dado que se desconoce la forma de la trayectoria $L$ descrita entre los dos instantes de muestreo. En la práctica se aplica una aproximación lineal o circular, de forma que $L$ se aproxima a una recta o a un arco de circunferencia de radio $R$ y centro de giro en $C$.

Para el caso de la aproximación lineal el ángulo del segmento AB $\theta_{avg}$ se calcula como el valor medio del ángulo en cada punto:

\begin{equation}
\theta_{avg} = \frac{\theta_n + \theta_{n-1}}{2}
\end{equation}

Por la aproximación lineal, $L$ se corresponde con la longitud del segmento AB:
\begin{equation}
L = d_n - d_{n-1}
\end{equation}

El valor de $dx$ y $dy$ para la aproximación lineal se obtiene como:

\begin{empheq}[box=\fbox]{align}
dx &= L\,\cos(\theta_{avg})\\
dy &= L\,\sin(\theta_{avg})
\end{empheq}

El cálculo de odometría utilizando la aproximación circular se resuelve en \cite{rcva_odometri}. Para dicha aproximación el valor de $dx$ y $dy$ se obtiene como:

\begin{empheq}[box=\fbox]{align}
dx &= K\,L\,\cos(\theta_{avg})\\
dy &= K\,L\,\sin(\theta_{avg})
\end{empheq}

Siendo  
\begin{align}
K &= \frac{\sin(\nabla\theta_n/2)}{\nabla\theta_n/2} \\
\nabla \theta_n &= \theta_n - \theta_{n-1}
\end{align}

Observar que las expresiones de ambas aproximaciones difieren únicamente en el factor $K$ que constituye un factor de escala para $L$. El estudio comparativo entre ambas aproximaciones realizada en \cite{rcva_odometri} demuestra que para las condiciones de un robot de Eurobot la aproximación circular no añade ninguna ventaja frente a la aproximación lineal. En la aproximación circular, además de necesitar mayor tiempo de cálculo, la corrección aportada por $K$ para trayectorias muy exigentes se encuentra en $1\times10^{-5}$ y $2\times10^{-5}$, algo despreciable.



\subsection{Medida y corrección de errores sistemáticos}

El principal inconveniente de la odometría es la acumulación continua de error a medida que el robot se desplaza. Estos errores pueden sistemáticos y no sistemáticos. 

\begin{description}
\item Errores sistemáticos
\begin{enumerate}
\item Diferente diámetro de las ruedas de encoder.
\item Valor medio del diámetro de las ruedas de encoder diferente del diámetro nominal.
\item Ruedas de encoder desalineadas.
\item Incertidumbre en la distancia efectiva entre ejes de las ruedas de encoder o de tracción (debido al punto de apoyo con el suelo).
\item Resolución del encoder insuficiente
\item Tiempo de muestreo limitado
\end{enumerate}

\item Errores no sistemáticos
\begin{enumerate}
\item Trayectos sobre suelos irregulares
\item Trayectos sobre objetos inesperados en el suelo
\item Deslizamiento de las ruedas de encoder debido a: sobre-aceleraciones, suelos resbaladizos, fuerzas externas (colisión con robot oponente), fuerzas internas (bloqueo de los rollones) o falta de contacto de as ruedas con el suelo.
\end{enumerate}
\end{description}

Los errores sistemáticos son particularmente graves debido a que se acumulan constantemente, incluso llegan a contribuir al error más que los errores no sistemáticos. 

Los errores no sistemáticos debido a superficies irregulares podrían contribuir más que los sistemáticos, pero no es el caso de los robots Eurobot donde las superficies son lisas. Además, el sistema de amortiguación de las ruedas libres de la plataforma robótica permite evitar los errores no sistemáticos debido al deslizamiento de las ruedas.

Respecto a los errores sistemáticos, las ecuaciones de cálculo de la odometría pueden introducir errores debido a la aproximación del método utilizado en su cálculo. La precisión en dicho cálculo depende del tiempo de muestreo frente a la velocidad del robot. Este error puede considerarse despreciable si se trabaja con periodos de muestreo de $T_s<10\,ms$ para velocidades de $v < 1\,m/s$ \cite{bor96_ieeet}.

Los errores sistemáticos no suelen cambiar durante el recorrido del robot, aunque la distribución de pesos sobre las ruedas de encoders puede afectar si estas se encuentran solidarias a la estructura del robot. No es el caso del sistema de ruedas libres desarrollado en el que estas se encuentra desacopladas mediante un mecanismo lineal o pivotante con amortiguación.

Los errores sistemáticos son normalmente causados por imperfecciones en la implementación del diseño y la mecánica del robot. Las dos fuentes de errores sistemáticos más significativas son la diferencia de diámetros de rueda de encoder y la incertidumbre en la distancia efectiva entre ejes de las ruedas de encoder o de tracción.

El error por diferente diámetro de rueda de encoder se representa por $E_d$  y se define como

\begin{equation}
E_d = \frac{D_R}{D_L}
\end{equation}

donde $D_R$ y $D_L$ son los diámetros reales de las ruedas de los encoders, siendo la relación nominal entre diámetro de ruedas $1.0$.

Como muestra la ecuación \eqref{eq_coef_angle} la medida de ángulo del robot depende de la distancia entre ejes de ruedas de encoder $b$. Por lo tanto una incertidumbre en dicha distancia implica un error en el cálculo. Este error se denota como $E_b$ y se define como

\begin{equation}
E_b = \frac{b_{real}}{b_{nominal}}
\end{equation}

donde $b$ es la distancia entre ejes de ruedas de encoder.

Según \cite{bor96_ieeet} si se quiere reducir los errores de odometría, los errores de ángulo son la principal preocupación ya que una vez se incurre en ellos crecen sin límite. Por ello, en \cite{bor96_ieeet} se analiza el efecto de diferentes diámetros de rueda de encoder durante los giros del robot. La figura \ref{fig_paper58_errores_giro} representa el análisis realizado. Debido a la diferencia de diámetro de rueda el centro de giro del robot real es el punto $O$. Los giros sobre dicho punto generar un error de desplazamiento representado por el punto $C$.
 
\begin{figure}[ht]
\centering
\includegraphics[width=.5\textwidth]{paper58_errores_giro}
\caption[Análisis de la influencia de errores sistemáticos durante el giro del robot.]{Análisis de la influencia de diferentes diámetros de rueda e incertidumbre de la distancia entre ejes durante el giro del robot. Imagen obtenida de \cite{bor96_ieeet}.}
\label{fig_paper58_errores_giro}
\end{figure}


El estudio revela que \emph{el diámetro medio real de la ruedas es al ángulo de giro real como el diámetro nominal de la rueda al ángulo de giro nominal} y se deducen \emph{tres importantes conclusiones}:

\begin{enumerate}
\item Diámetros distintos de rueda no causan un error de orientación durante los giros.
\item El error de orientación depende del \emph{diámetro medio de las ruedas} $D_{avg}$ expresado como:

\begin{equation}
\boxed{D_{avg} = \frac{D_L+D_R}{2}} \label{eq_D_avg}
\end{equation}

Si $D_{avg} > D_n$ el robot girará más de lo deseado. Si $D_{avg} < D_n$ entonces el robot girará menos.

\item $E_d$ tiene un efecto menor en la posición $x$ e $y$ del centro de giro produciendo un error de desplazamiento lateral.

\end{enumerate}


\subsubsection{Test del cuadrado bidireccional}

Uno de los test que se suelen realizar con el fin de medir y corregir los errores de odometría es el test del cuadrado. En este test el robot realiza una trayectoria programada cuyo camino coincide con un cuadrado como muestra la figura \ref{fig_paper58_square_test}. El robot comienza y termina en el mismo punto, al terminar el recorrido se mide la diferencia de la posición inicial y la final respecto a una pared de referencia. Debido al error $E_d$ el robot realizará trayectorias curvas durante los trayectos rectos, y debido al error $E_b$ el robot cometerá un error en los giros, como muestra la figura \ref{fig_paper58_square_test}


\begin{figure}[ht]
\centering
\includegraphics[width=.9\textwidth]{paper58_square_test}
\caption[]{Test del cuadrado. Imagen obtenida de \cite{bor96_ieeet}}
\label{fig_paper58_square_test}
\end{figure}

\begin{figure}[p]
\centering
\includegraphics[width=.5\textwidth]{paper58_compensacion_errores}
\caption[]{Test del cuadrado: cancelación de errores $E_b$ y $E_d$. Imagen obtenida de \cite{bor96_ieeet}}
\label{fig_paper58_compensacion_errores}
\end{figure}

\begin{figure}[p]
\centering
\includegraphics[width=.42\textwidth]{paper58_error_tipo_a}
\includegraphics[width=.42\textwidth]{paper58_error_tipo_b}
\caption[]{Test del cuadrado bidireccional. Efecto del error tipo A y B en la trayectoria y punto final del robot. Imagen obtenida de \cite{bor96_ieeet}}
\label{fig_paper58_error_a_b}
\end{figure}

Sin embargo este test puede llevar a medidas erróneas debido a que los errores sistemáticos se pueden cancelar entre sí como muestra la figura \ref{fig_paper58_compensacion_errores}. En \cite{bor96_ieeet} proponen un método que soluciona este inconveniente: el test del cuadrado bidireccional. En este test el robot realiza la trayectoria del cuadrado en dos direcciones: en sentido horario y antihorario de forma que aunque los errores se enmascaren en la trayectoria en un sentido, darán la cara en el sentido contrario. El método es iterativo de forma que a cada iteración la corrección de los errores sistemáticos es mayor.

Así se definen dos tipos de errores: el error tipo A asociado a $E_b$ debido a la distancia entre ejes de ruedas de encoder, el error tipo B asociado a $E_d$ debido a diferente diámetro de rueda de encoder. La figura \ref{fig_paper58_error_a_b} representa el efecto de estos errores al realizar el test del cuadrado bidireccional.

Los resultados presentados en \cite{bor96_ieeet} utilizando el método del cuadrado bidireccional son satisfactorios. Este método ha sido utilizado para medir y corregir los errores de odometría del robot de Eurobot. Para la realización del test se realizó una trayectoria cuadrada de $1,5m$ de lado y se utilizó una cinta métrica para medir la posición del robot. Se realizaron 2 iteraciones obteniendo como resultado una mejora en los errores de odometría, pero no comparables con los resultados de \cite{bor96_ieeet}. Se cree que la diferencia de resultados fue debida a la longitud del camino recorrido ($1,5m$ frente a $4m$ en el caso de \cite{bor96_ieeet}) y a la poca precisión de la herramienta de medida ya que en \cite{bor96_ieeet} realizaron medidas por ultrasonidos.

\subsubsection{Método utilizado}

En la practica la medida y corrección de errores sistemáticos de odometría $E_d$ y $E_b$ se ha realizado utilizando un método propio. Este método realiza la corrección de cada error por separado teniendo en cuenta su dependencia. El método se divide en 2 partes:

\begin{enumerate}
\item Medida y corrección del error $E_d$.
\item Medida y corrección del error $E_b$.
\end{enumerate} 

El orden de realización es importante ya que $E_d$ influye sobre $E_b$.

%\begin{description}
%\item \textbf{Medida y corrección del error $E_d$}
\subsubsection*{Medida y corrección del error $E_d$}

Partiendo del sistema de ruedas libres de encoder diseñado (ver sección \ref{sec_sma_posicionamiento_y_control}), una primera aproximación del valor de $E_d$ se obtiene de la medida directa de la llanta de aluminio de las ruedas del encoder. Dicha medida se puede realizar con un calibre. Otra parte del error $E_d$ viene dado por el echo de que las ruedas están formadas además por una junta tórica de goma que va a sufrir deformaciones debido a la amortiguación pivotante o lineal. 

Para la medida y corrección de $E_d$ se necesita una superficie lisa y una pared de referencia. En caso de disponer de un campo de juego, se puede utilizar el lado largo del mismo y su paredes como referencia. La figura \ref{fig_odometria_correccion_error_tipo_b} representa el test a realizar. Se recomienda utilizar una velocidad y aceleración baja con el fin de evitar deslizamientos.

\begin{figure}[ht]
\centering
\includegraphics[width=.5\textwidth]{odometria_correccion_error_tipo_b}
\caption[]{Método utilizado para corregir el error de odometría $E_d$. La trayectoria se ha exagerado.}
\label{fig_odometria_correccion_error_tipo_b}
\end{figure}

El método consta de los siguientes pasos:

\begin{enumerate}
\item Situar el robot paralelo y cerca de las paredes de referencia. Fijar la posición del robot $(x,y,\theta)$ a $(0,0,0)$. Medir la distancia  del centro del eje motriz del robot, punto A, a las paredes de referencia.
\item Hacer recorrer al robot una distancia A-B lo mayor posible en linea recta ($2,7m$ aproximadamente en caso de utilizar un campo de Eurobot).
\item Medir la distancia del centro del eje motriz del robot, punto C, a las paredes de referencia. Compensar la medida con la posición de odometría dada por el robot $(x_r,y_r,\theta_r)$.
\end{enumerate} 

Si el error $E_d$ fuese nulo los puntos B y C deberían coincidir. El análisis utilizado para el cálculo de $E_d$ es similar al realizado en \cite{bor96_ieeet} para el cálculo de error tipo B. Debido al la diferencia de diámetros el robot va a realizar una trayectoria curva de radio R y centro de giro C (ver figura \ref{fig_paper58_radio_ed}). 

%\begin{figure}[ht]
%\centering
%\includegraphics[width=.8\textwidth]{paper58_radio_ed}
%\caption[]{Radio de giro exagerado generado durante una trayectoria recta debido a diferentes diámetros de rueda de encoder. Fuente: \cite{bor96_ieeet}}
%\label{fig_paper58_radio_ed}
%\end{figure}

\begin{figure}[ht]
\centering
\includegraphics[width=.7\textwidth]{odometria_radio_ed}
\caption[]{Radio de giro exagerado generado durante una trayectoria recta debido a diferentes diámetros de rueda de encoder.}
\label{fig_paper58_radio_ed}
\end{figure}


Dicho radio se obtiene al a partir del cálculo de la distancia L y del ángulo $\beta$ de la siguiente manera:
\begin{align}
L =& \sqrt{(x_C-x_A)^2 + (y_C-y_A)^2} \\
\beta/2 =& \arctan{\frac{x_C-x_A}{y_C-y_A}} \\
R =& \frac{L/2}{\sin(\beta/2)}
\end{align}

El error $E_d$ viene dado como 
\begin{equation}
\boxed{E_d = \frac{D_R}{D_L} = \frac{R+b/2}{R-b/2}}
\end{equation}

Donde el valor de $b$ se obtiene de midiendo la distancia entre ejes de encoder utilizando un calibre.

Los factores de corrección de cada rueda se deducen de la ecuación \eqref{eq_D_avg} como
\begin{empheq}[box=\fbox]{align}
c_L =& \frac{2}{E_d +1} \\
c_R =& \frac{2}{(1/E_d) + 1}
\end{empheq}

y se aplican al diámetro nominal de cada rueda como:
\begin{align}
D_L =& D_n \times c_L \\
D_R =& D_n \times c_R
\end{align}

La versión experimental de este método consiste ir realizar los pasos anteriormente descritos e ir ajustando $E_d$ partiendo de un valor $E_d = 1,0$ utilizando aproximaciones sucesivas hasta obtener un error asumible. Esta aplicación experimental del método permite verificar la implementación de las correcciones de odometría y comprender mejor el fundamento de la corrección.

Aplicada la corrección del error $E_d$ se vuelve a realizar el test con el fin de comprobar su efecto.

Por último, se vuelve a realizar la trayectoria AB con el fin de corregir el valor de diámetro nominal de ruedas de encoders $D_n$. El valor del diámetro nominal se encuentra en el coeficiente de conversión de distancia $C_d$ \eqref{eq_coef_d}. Debido a la deformación de la junta tórica de las ruedas de encoder el valor del diámetro nominal suele variar produciendo un error en la distancia recorrida por el robot. Notar que este error afecta por igual a ambas ruedas de encoder.

Para medir este error se vuelve a realizar la trayectoria AB. A partir de la medida de la distancia AB recorrida por el robot y de la medida de odometría del robot $(x_r,y_r,\theta_r)$ se calcula un factor de corrección $G_d$ para el coeficiente de distancia $C_d$ como
\begin{equation}
G_d = \frac{d_r}{d_{AB}} \simeq \frac{y_r}{d_{AB}}
\end{equation}

el cual se aplica al coeficiente de distancia de la siguiente forma
\begin{equation}
C_d' = C_d \times G_d.
\end{equation}


%\item \textbf{Medida y corrección del error $E_b$}
\subsubsection*{Medida y corrección del error $E_b$}

El procedimiento para la medida del error $E_b$ consiste en hacer girar al robot sobre su centro de giro. Dado que el cálculo del ángulo del robot \eqref{eq_angle_rad} $\theta$ es inversamente proporcional a la distancia entre ejes $b$ el método utilizado busca amplificar el error producido por $b$ girando un numero $n$ de vueltas enteras.

Para la medida del error $E_b$ se necesita una superficie lisa una regla larga, una escuadra y un cartabón. Al igual que en el método de medida de $E_d$ puede utilizarse el campo de juego. Se recomienda utilizar una velocidad y aceleración baja con el fin de evitar deslizamientos.

\begin{figure}[ht]
\centering
\includegraphics[width=.3\textwidth]{odometria_correccion_error_tipo_a}
\caption[]{Método utilizado para medir el error de odometría $E_b$.}
\label{fig_odometria_correccion_error_tipo_a}
\end{figure}

La figura \ref{fig_odometria_correccion_error_tipo_a} representa el el procedimiento a realizar, el cual consta de los siguientes pasos:

\begin{enumerate}
\item Posicionar el robot sobre el suelo y fijar la posición del robot $(x,y,\theta)$ a $(0,0,0)$. Con ayuda de una regla y un marcador trazar una linea en el suelo paralela a la cara posterior del robot.
\item Llevar al robot a ángulo relativo $\theta = 3600$ grados (10 vueltas).
\item Apuntar la medida absoluta de ángulo del robot $\theta_r$ y volver a trazar una linea en el suelo paralela a la cara posterior del robot. 
\item Construir el triángulo ABC y calcular el ángulo $\alpha$.
\begin{equation}
\alpha = \arctan \Big(\frac{CA}{CB}\Big) + \theta_r
\end{equation}
\end{enumerate}

El factor de corrección $c_b$ para el error $E_b$ viene dado por la expresión
\begin{equation}
\boxed{c_b = \frac{\theta}{\theta \pm \alpha} = \frac{3600}{3600 \pm \alpha}}
\end{equation}

Donde $\alpha$ suma o resta dependiendo de si el robot a girado más o menor de 3600 grados, respectivamente. Aplicado a la distancia nominal entre ejes $b_n$ se obtiene el valor corregido 

\begin{equation}
b = b_n \times c_b.
\end{equation}

%\end{description}






% TODO
%\subsection{Compensación de la fuerza centrípeta}







%%% Local Variables:
%%% TeX-master: "../book"
%%% End:
